// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ExampleModel {
  id                   Int      @id @default(autoincrement())
  name                 String
  createdAt            DateTime @default(now())
}

// ===== SISTEMA DE CONTROLE DE HORAS =====

model User {
  id                   Int      @id @default(autoincrement())
  name                 String
  email                String   @unique
  password             String
  perfil               UserPerfil @default(COLABORADOR)
  perfilDeCustoId      Int?
  perfilDeCusto        PerfilDeCusto? @relation(fields: [perfilDeCustoId], references: [id])
  custoHora            Decimal? @db.Decimal(10, 2)
  cargaSemanalHoras    Int      @default(40)
  ativo                Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relacionamentos
  lancamentosHora      LancamentoHora[]
  batidasPonto         BatidaPonto[]
  alocacoes            Alocacao[]
  bancoHorasMovimentos BancoHorasMovimento[]
  projetosGerenciados  Projeto[] @relation("ProjetoGestor")
  
  @@map("users")
}

model PerfilDeCusto {
  id                   Int      @id @default(autoincrement())
  nome                 String   // ex: "Júnior", "Pleno", "Sênior"
  custoHora            Decimal  @db.Decimal(10, 2)
  ativo                Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relacionamentos
  users                User[]
  projetoEstimativas   ProjetoEstimativaPerfil[]
  projetoContratos     ProjetoContratoMensalPerfil[]
  lancamentosHoraSnapshot LancamentoHora[]
  
  @@map("perfis_de_custo")
}

model Projeto {
  id                   Int      @id @default(autoincrement())
  nome                 String
  cliente              String?
  centroCusto          String?
  status               ProjetoStatus @default(ATIVO)
  billingModel         BillingModel
  feeTipo              FeeTipo?
  feeValor             Decimal? @db.Decimal(12, 2)
  gestorId             Int
  gestor               User @relation("ProjetoGestor", fields: [gestorId], references: [id])
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relacionamentos
  tarefas              Tarefa[]
  alocacoes            Alocacao[]
  lancamentosHora      LancamentoHora[]
  batidasPonto         BatidaPonto[]
  estimativas          ProjetoEstimativaPerfil[]
  contratos            ProjetoContratoMensalPerfil[]
  parcelas             ProjetoFeeParcela[]
  
  @@map("projetos")
}

model Tarefa {
  id                   Int      @id @default(autoincrement())
  projetoId            Int
  projeto              Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  nome                 String
  orcamentoHoras       Decimal? @db.Decimal(8, 2)
  ativo                Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relacionamentos
  alocacoes            Alocacao[]
  lancamentosHora      LancamentoHora[]
  
  @@map("tarefas")
}

model Alocacao {
  id                   Int      @id @default(autoincrement())
  userId               Int
  user                 User @relation(fields: [userId], references: [id])
  projetoId            Int
  projeto              Projeto @relation(fields: [projetoId], references: [id])
  tarefaId             Int?
  tarefa               Tarefa? @relation(fields: [tarefaId], references: [id])
  dtInicio             DateTime
  dtFim                DateTime?
  ativo                Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@map("alocacoes")
}

model BatidaPonto {
  id                   Int      @id @default(autoincrement())
  userId               Int
  user                 User @relation(fields: [userId], references: [id])
  data                 DateTime @db.Date
  tipo                 TipoBatida
  projetoId            Int?
  projeto              Projeto? @relation(fields: [projetoId], references: [id])
  observacao           String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@map("batidas_ponto")
}

model LancamentoHora {
  id                   Int      @id @default(autoincrement())
  userId               Int
  user                 User @relation(fields: [userId], references: [id])
  projetoId            Int
  projeto              Projeto @relation(fields: [projetoId], references: [id])
  tarefaId             Int?
  tarefa               Tarefa? @relation(fields: [tarefaId], references: [id])
  data                 DateTime @db.Date
  inicio               DateTime?
  fim                 DateTime?
  horas                Decimal? @db.Decimal(6, 2)
  modoRegistro         ModoRegistro
  classificacaoColaborador ClassificacaoColaborador
  classificacaoProjeto ClassificacaoProjeto
  perfilDeCustoSnapshotId Int?
  perfilDeCustoSnapshot PerfilDeCusto? @relation(fields: [perfilDeCustoSnapshotId], references: [id])
  custoHoraSnapshot    Decimal? @db.Decimal(10, 2)
  precoHoraSnapshot     Decimal? @db.Decimal(10, 2)
  ehForaHorario        Boolean  @default(false)
  motivoEdicao          String?
  criadoPor            Int?
  atualizadoPor        Int?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@map("lancamentos_hora")
}

model BancoHorasMovimento {
  id                   Int      @id @default(autoincrement())
  userId               Int
  user                 User @relation(fields: [userId], references: [id])
  data                 DateTime @db.Date
  horas                Decimal  @db.Decimal(6, 2)
  tipo                 TipoMovimentoBanco
  origem               OrigemMovimentoBanco
  referenciaLancamentoId Int?
  observacao           String?
  createdAt            DateTime @default(now())
  
  @@map("banco_horas_movimentos")
}

model ProjetoEstimativaPerfil {
  id                   Int      @id @default(autoincrement())
  projetoId            Int
  projeto              Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  perfilDeCustoId      Int
  perfilDeCusto        PerfilDeCusto @relation(fields: [perfilDeCustoId], references: [id])
  horasEstimadas       Decimal  @db.Decimal(8, 2)
  custoHoraSnapshot    Decimal  @db.Decimal(10, 2)
  precoHoraSnapshot     Decimal? @db.Decimal(10, 2)
  createdAt            DateTime @default(now())
  
  @@map("projeto_estimativas_perfil")
}

model ProjetoContratoMensalPerfil {
  id                   Int      @id @default(autoincrement())
  projetoId            Int
  projeto              Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  mesCompetencia       String   // YYYY-MM
  perfilDeCustoId      Int
  perfilDeCusto        PerfilDeCusto @relation(fields: [perfilDeCustoId], references: [id])
  horasContratadasMes  Decimal  @db.Decimal(8, 2)
  precoHoraContratada  Decimal  @db.Decimal(10, 2)
  precoHoraAdicional    Decimal  @db.Decimal(10, 2)
  precoHoraForaHorario Decimal  @db.Decimal(10, 2)
  precoHoraExtra        Decimal  @db.Decimal(10, 2)
  custoHoraSnapshot    Decimal  @db.Decimal(10, 2)
  createdAt            DateTime @default(now())
  
  @@map("projeto_contratos_mensais_perfil")
}

model ProjetoFeeParcela {
  id                   Int      @id @default(autoincrement())
  projetoId            Int
  projeto              Projeto @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  tipoParcela          TipoParcela
  descricaoMarco       String?
  vencimento           DateTime
  valor                Decimal  @db.Decimal(12, 2)
  pago                 Boolean  @default(false)
  createdAt            DateTime @default(now())
  
  @@map("projeto_fee_parcelas")
}

model Feriado {
  id                   Int      @id @default(autoincrement())
  data                 DateTime @db.Date
  nome                 String
  tipo                 TipoFeriado
  createdAt            DateTime @default(now())
  
  @@map("feriados")
}

model CapacidadeCalendario {
  id                   Int      @id @default(autoincrement())
  userId               Int
  data                 DateTime @db.Date
  horasEsperadas       Decimal  @db.Decimal(6, 2)
  createdAt            DateTime @default(now())
  
  @@map("capacidade_calendario")
}

model Notificacao {
  id                   Int      @id @default(autoincrement())
  userId               Int
  tipo                 TipoNotificacao
  dataAgendada         DateTime
  status               StatusNotificacao @default(PENDENTE)
  payload              Json?
  enviadaEm            DateTime?
  createdAt            DateTime @default(now())
  
  @@map("notificacoes")
}

// ===== ENUMS =====

enum UserPerfil {
  ADMIN
  GESTOR
  COLABORADOR
}

enum ProjetoStatus {
  ATIVO
  PAUSADO
  CONCLUIDO
  CANCELADO
}

enum BillingModel {
  ESCOPO_FECHADO
  ALOCACAO
}

enum FeeTipo {
  FIXO
  POR_HORA
}

enum TipoBatida {
  ENTRADA
  SAIDA_ALMOCO
  VOLTA_ALMOCO
  SAIDA
}

enum ModoRegistro {
  TIMESHEET
  PONTO
}

enum ClassificacaoColaborador {
  NORMAL
  EXTRA
  BANCO
}

enum ClassificacaoProjeto {
  NORMAL
  EXTRA
}

enum TipoMovimentoBanco {
  CREDITO
  DEBITO
}

enum OrigemMovimentoBanco {
  EXTRA
  AJUSTE
}

enum TipoParcela {
  MARCO
  MENSAL
}

enum TipoFeriado {
  NACIONAL
  LOCAL
}

enum TipoNotificacao {
  LEMBRETE_BATIDA
  OUTRO
}

enum StatusNotificacao {
  PENDENTE
  ENVIADA
  FALHOU
}